version: "3.9"

services:
  postgres:
    image: postgres:17
    container_name: mc-postgres-dev
    environment:
      POSTGRES_USER: musiconnect_app
      POSTGRES_PASSWORD: mc_password
      POSTGRES_DB: musicconnect
    ports:
      - "5433:5432"          # host:container (using 5433 to avoid conflict with existing PostgreSQL)
    volumes:
      - mc-postgres-data:/var/lib/postgresql/data
      # Optional: auto-load schema on first init
      - ./docs/musiconnect_pgdb_schema_v2.sql:/docker-entrypoint-initdb.d/musiconnect_schema.sql:ro
    networks:
      - musicconnect-net

  auth-service:
    build:
      context: ./services/auth-service
    container_name: musiconnect-auth
    env_file:
      - ./services/auth-service/.env
    depends_on:
      - postgres
    ports:
      - "3001:3001"
    networks:
      - musicconnect-net

  unified-search:
    build:
      context: ./services/unified_search
    container_name: musicconnect-unified-search
    env_file:
      - ./services/unified_search/.env
    depends_on:
      - spotify-connector
      - youtube-connector
    ports:
      - "8004:8000"          # host 8004 -> container 8000 (FastAPI)
    networks:
      - musicconnect-net

  playlist-migration:
    build:
      context: ./services/playlist_migration
    container_name: musicconnect-playlist-migration
    env_file:
      - ./services/playlist_migration/.env
    depends_on:
      - spotify-connector
      - youtube-connector
    ports:
      - "8083:8000"          # host 8083 -> container 8000 (FastAPI)
    networks:
      - musicconnect-net

  spotify-connector:
    build:
      context: ./music_connect/connectors/spotify_connector
    container_name: musicconnect-spotify-connector
    env_file:
      - ./music_connect/connectors/spotify_connector/.env
    ports:
      - "8081:8000"          # host 8081 -> container 8000
    networks:
      - musicconnect-net

  youtube-connector:
    build:
      context: ./music_connect/connectors/youtube_connector
    container_name: musicconnect-youtube-connector
    env_file:
      - ./music_connect/connectors/youtube_connector/.env
    volumes:
      - ./music_connect/connectors/youtube_connector/youtube_oauth_credentials.json:/app/youtube_oauth_credentials.json:ro
    ports:
      - "8000:8000"          # host 8000 -> container 8000
    networks:
      - musicconnect-net

  ui:
    build:
      context: ./music_connect_ui
    container_name: musicconnect-ui
    env_file:
      - ./music_connect_ui/.env
    ports:
      - "3000:3000"          # UI on http://localhost:3000
    depends_on:
      - auth-service
      - unified-search
      - spotify-connector
      - youtube-connector
      - playlist-migration
    networks:
      - musicconnect-net

networks:
  musicconnect-net:

volumes:
  mc-postgres-data:
